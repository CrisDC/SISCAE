<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pe.edu.unmsm.fisi.siscae.mapper.IReporteEstadisticaPrestamosMapper">

	
	
	<!--    ¡¡ OBSERVACION !!              '&lt;'   significa   '<' -->
	
	<select id="buscarRankingAlumno" resultMap="consultaRank">
			
		SELECT al.v_codigo_alumno AS codigo,
		 CONCAT(pe.v_nombre,' ',pe.v_app_paterno,' ',pe.v_app_materno) AS nombres ,
		 COUNT(pr.n_id_persona) AS cantidad,
		 ar.n_id_area_estudio AS idArea,
		 al.n_id_escuela AS idEscuela,
		 es.n_id_facultad AS idFacultad,
		 es.v_nombre AS escuela
		FROM mae_alumno al
		LEFT JOIN mae_persona pe ON ( al.n_id_alumno= pe.n_id_persona)
		LEFT JOIN mov_prestamo pr ON ( pe.n_id_persona= pr.n_id_persona)
		LEFT JOIN mae_recurso re	ON ( pr.n_id_recurso =re.n_id_recurso)
		LEFT JOIN mae_area_estudio ar	ON ( re.n_id_area_estudio =ar.n_id_area_estudio)
		LEFT JOIN mae_escuela es	ON ( es.n_id_escuela = al.n_id_escuela)
		WHERE (pr.d_fecha BETWEEN "22-10-2018" AND sysdate()) 
		<if test="areasEstudio != null">
			        AND re.n_id_area_estudio IN
			        <foreach item="item" index="index" collection="areasEstudio"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
					  
				<if test="facultades != null">
			        AND es.n_id_facultad IN 
			        <foreach item="item" index="index" collection="facultades"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
					  
				<if test="escuelas != null">
			        AND al.n_id_escuela IN 
			        <foreach item="item" index="index" collection="escuelas"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    
			    
		</if>
			    
			    
		
		
		
		GROUP BY nombres
		ORDER BY cantidad DESC
		LIMIT 10;
			
			
			
	</select>
	
	<select id="buscarRankingEscuela" resultMap="consultaRankEsc">
		SELECT es.v_nombre AS escuela , COUNT(pr.n_id_persona) AS cantidad
		FROM mae_alumno al
		LEFT JOIN mae_escuela es ON ( al.n_id_escuela= es.n_id_escuela)
		LEFT JOIN mae_persona pe ON ( al.n_id_alumno= pe.n_id_persona)
		LEFT JOIN mov_prestamo pr ON ( pe.n_id_persona= pr.n_id_persona)
		LEFT JOIN mae_recurso re	ON ( pr.n_id_recurso =re.n_id_recurso)
		WHERE (pr.d_fecha BETWEEN "22-10-2018" AND sysdate()) 
		
		<if test="areasEstudio != null">
			        AND re.n_id_area_estudio IN
			        <foreach item="item" index="index" collection="areasEstudio"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
					  
				
		</if>
		
		group by escuela
		order by 2 desc
			
	</select>
	
	<select id="buscarRankingFacultad" resultMap="consultaRankFac">
			
		SELECT fa.v_nombre AS facultad , COUNT(pr.n_id_persona) AS cantidad
		FROM mae_alumno al
		LEFT JOIN mae_escuela es ON ( al.n_id_escuela= es.n_id_escuela)
		LEFT JOIN mae_facultad fa ON ( es.n_id_facultad= fa.n_id_facultad)
		LEFT JOIN mae_persona pe ON ( al.n_id_alumno= pe.n_id_persona)
		LEFT JOIN mov_prestamo pr ON ( pe.n_id_persona= pr.n_id_persona)
		LEFT JOIN mae_recurso re	ON ( pr.n_id_recurso =re.n_id_recurso)
		WHERE (pr.d_fecha BETWEEN "22-10-2018" AND sysdate()) 
		
		<if test="areasEstudio != null">
			        AND re.n_id_area_estudio IN
			        <foreach item="item" index="index" collection="areasEstudio"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
					  
				
		</if>
		
		group by facultad
		order by 2 desc
			    
		
	</select>
	
	
	<select id="buscarPorPeriodoSinSegementar" resultMap="objetoSinSegmentar">
			WITH RECURSIVE ListaPeriodo  AS
			(		
				<if test="tipoPeriodo == 'DIA'">
					SELECT #{fechaInicio}  						AS fecha					
					UNION ALL
					SELECT DATE_ADD(fecha,INTERVAL 1 DAY) 		AS fecha	
					FROM ListaPeriodo
					WHERE fecha &lt; #{fechaFin}
				</if>
				
				<if test="tipoPeriodo == 'SEMANA'">
					SELECT 	#{semanaInicio}                    	AS semana,
							#{anioInicio}						AS anio
					UNION ALL
					SELECT IF(semana &lt;= 51,semana + 1,1) 		AS semana,
						   IF(semana = 52,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND semana &lt; #{semanaFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'MES'">
					SELECT #{mesInicio} 						AS mes,
						   #{anioInicio}						AS anio
					UNION ALL
					SELECT IF(mes &lt;= 11,mes + 1,1) 			AS mes,
						   IF(mes = 12,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND mes &lt; #{mesFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'ANIO'">
					SELECT #{anioInicio} 						AS anio
					UNION ALL
					SELECT (anio+1) 							AS anio
					FROM ListaPeriodo
					WHERE anio &lt; #{anioFin}
				</if>
					
			)
			SELECT
				COUNT(reporte.estadia)										AS numeroPrestamos,
			<if test="tipoPeriodo == 'DIA'">
			    lista.fecha 												AS ejeX,
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
			    CONCAT(lista.anio,'-',lista.semana)							AS ejeX,
			</if>
			<if test="tipoPeriodo == 'MES'">
			    CONCAT(lista.anio,'-',lista.mes)							AS ejeX,
			</if>
			<if test="tipoPeriodo == 'ANIO'">
			    lista.anio													AS ejeX,
			</if>
				IFNULL(SEC_TO_TIME2(SUM(TIME_TO_SEC(reporte.estadia))),0) 	AS estadiaTotal,
			    IFNULL(SEC_TO_TIME(AVG(TIME_TO_SEC(reporte.estadia))),0)  	AS estadiaPromedio
			
			FROM ListaPeriodo lista
			
			<if test="tipoPeriodo == 'DIA'">
			LEFT JOIN vw_reporte_prestamos reporte ON (reporte.fecha_registro = lista.fecha)
			
			</if>
			
			<if test="tipoPeriodo == 'SEMANA'">
			LEFT JOIN vw_reporte_prestamos reporte ON (CONCAT(lista.anio,'-',lista.semana) = CONCAT(YEAR(reporte.fecha_registro),'-',WEEK(reporte.fecha_registro)))
			
			</if>
			<if test="tipoPeriodo == 'MES'">
			LEFT JOIN vw_reporte_prestamos reporte ON (CONCAT(lista.anio,'-',lista.mes) = CONCAT(YEAR(reporte.fecha_registro),'-',MONTH(reporte.fecha_registro)))
			
			</if>
			 <if test="tipoPeriodo == 'ANIO'">
			LEFT JOIN vw_reporte_prestamos reporte ON (lista.anio = YEAR(reporte.fecha_registro))
			
			</if>
			
			<where>
				<if test="areasEstudio != null">
			        reporte.id_area_estudio IN
			        <foreach item="item" index="index" collection="areasEstudio"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    
			    <if test="escuelas != null">
			        AND reporte.id_escuela IN 
			        <foreach item="item" index="index" collection="escuelas"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    		    
			    <if test="recursos != null ">
			        AND reporte.id_tipo_recurso IN
			        <foreach item="item" index="index" collection="recursos"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    
			    <if test="solicitantes != null and solicitantes != '' ">
			        AND reporte.nombre_tipo IN 
			        <foreach item="item" index="index" collection="solicitantes"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    
			    
			  </where>
			
			
			GROUP BY
			<if test="tipoPeriodo == 'DIA'">
			    lista.fecha
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
			    lista.anio,
    			lista.semana
			 </if>
			 <if test="tipoPeriodo == 'MES'">
				lista.anio,
				lista.mes
			 </if>
			 <if test="tipoPeriodo == 'ANIO'">
			    lista.anio
			 </if>
	</select>
	
	<select id="buscarPorCriterio" resultMap="objetoSinSegmentar">
		SELECT 
			COUNT(recurso) as numeroPrestamos,
			<if test="serie == 'ESCUELA'">
				escuela			as segmento,
			</if>
			<if test="serie == 'AREA_ESTUDIO'">
				area_estudio		as segmento,
			</if>
			<if test="serie == 'SOLICITANTE'">
				nombre_tipo		as segmento,
			</if>
			IFNULL(SEC_TO_TIME2(SUM(TIME_TO_SEC(estadia))),0) 	AS estadiaTotal,
    		IFNULL(SEC_TO_TIME(AVG(TIME_TO_SEC(estadia))),0)  	AS estadiaPromedio
		    
		FROM vw_reporte_prestamos
		WHERE 
			<if test="tipoPeriodo == 'DIA'">
				    (fecha_registro BETWEEN #{fechaInicio}  AND #{fechaFin})
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
				   (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio} ,null, null, #{semanaInicio} )
				   AND F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioInicio} ,null, null, #{semanaInicio} ) )
			</if>
			<if test="tipoPeriodo == 'MES'">
				  ( fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio} ,#{mesInicio}, null, null )
				   AND F_GENERADOR_FECHAS('FIN', 'MES',#{anioInicio} ,#{mesInicio}, null, null ))
			</if>
			<if test="tipoPeriodo == 'ANIO'">
				    (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio} ,null, null, null )
				   AND F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioInicio} ,null, null, null ) )
			</if>
			
			<if test="areasEstudio != null">
			        AND id_area_estudio IN
			        <foreach item="item" index="index" collection="areasEstudio"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    
			    <if test="escuelas != null">
			        AND id_escuela IN 
			        <foreach item="item" index="index" collection="escuelas"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    		    
			    <if test="recursos != null ">
			        AND id_tipo_recurso IN
			        <foreach item="item" index="index" collection="recursos"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
			    
			    <if test="solicitantes != null and solicitantes != '' ">
			        AND nombre_tipo IN 
			        <foreach item="item" index="index" collection="solicitantes"
					      open="(" separator="," close=")">
					        #{item}
					  </foreach>
			    </if>
		<if test="serie == 'ESCUELA'">
				GROUP BY escuela
		</if>
		<if test="serie == 'AREA_ESTUDIO'">
				GROUP BY area_estudio
		</if>
		<if test="serie == 'SOLICITANTE'">
				GROUP BY nombre_tipo
		</if>
		
	</select>
	
	<select id="buscarPorPeriodoSegmentado" resultMap="objetoSegmentado">
			WITH RECURSIVE ListaPeriodo  AS
			(		
				<if test="tipoPeriodo == 'DIA'">
					SELECT #{fechaInicio}  						AS fecha					
					UNION ALL
					SELECT DATE_ADD(fecha,INTERVAL 1 DAY) 		AS fecha	
					FROM ListaPeriodo
					WHERE fecha &lt; #{fechaFin}
				</if>
				
				<if test="tipoPeriodo == 'SEMANA'">
					SELECT 	#{semanaInicio}                    	AS semana,
							#{anioInicio}						AS anio
					UNION ALL
					SELECT IF(semana &lt;= 51,semana + 1,1) 		AS semana,
						   IF(semana = 52,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND semana &lt; #{semanaFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'MES'">
					SELECT #{mesInicio} 						AS mes,
						   #{anioInicio}						AS anio
					UNION ALL
					SELECT IF(mes &lt;= 11,mes + 1,1) 			AS mes,
						   IF(mes = 12,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND mes &lt; #{mesFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'ANIO'">
					SELECT #{anioInicio} 						AS anio
					UNION ALL
					SELECT (anio+1) 							AS anio
					FROM ListaPeriodo
					WHERE anio &lt; #{anioFin}
				</if>
					
			)
			SELECT
			      cr.v_nombre 												AS criterioSegmentacion,
				<if test="tipoPeriodo == 'DIA'">
					lista.fecha 											AS ejeX,
				    
					(SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN lista.fecha AND adddate(lista.fecha, INTERVAL 1 DAY) )
						 <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
							AND area_estudio=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'ESCUELA'">
							AND escuela=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
							AND nombre_tipo=cr.v_nombre
				  			
						</if>
						<if test="criterioSegmentacion == 'RECURSO'">
							AND tipo_recurso=cr.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos
					
				</if>
				<if test="tipoPeriodo == 'SEMANA'">
				    CONCAT(lista.anio,'-',lista.semana)							AS ejeX,
				    
				    (SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',lista.anio,null, null,lista.semana) AND F_GENERADOR_FECHAS('FIN', 'SEMANA',lista.anio,null, null,lista.semana) )
						 <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
							AND area_estudio=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'ESCUELA'">
							AND escuela=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
							AND nombre_tipo=cr.v_nombre
				  			
						</if>
						<if test="criterioSegmentacion == 'RECURSO'">
							AND tipo_recurso=cr.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos
				    
				</if>
				<if test="tipoPeriodo == 'MES'">
				    CONCAT(lista.anio,'-',lista.mes)							AS ejeX,
				    				    
				    (SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'MES',lista.anio,lista.mes, null,null) AND F_GENERADOR_FECHAS('FIN', 'MES',lista.anio,lista.mes, null,null) )
						 <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
							AND area_estudio=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'ESCUELA'">
							AND escuela=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
							AND nombre_tipo=cr.v_nombre
				  			
						</if>
						<if test="criterioSegmentacion == 'RECURSO'">
							AND tipo_recurso=cr.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos
				    
				</if>
				<if test="tipoPeriodo == 'ANIO'">
				    lista.anio													AS ejeX,
				    
				    (SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',lista.anio,null, null,null) AND F_GENERADOR_FECHAS('FIN', 'ANIO',lista.anio,null, null,null) )
						 <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
							AND area_estudio=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'ESCUELA'">
							AND escuela=cr.v_nombre
							
						</if>
						<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
							AND nombre_tipo=cr.v_nombre
				  			
						</if>
						<if test="criterioSegmentacion == 'RECURSO'">
							AND tipo_recurso=cr.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos
				    
				</if>

			FROM ListaPeriodo lista,
			
			<if test="criterioSegmentacion == 'AREA_ESTUDIO'">
				mae_area_estudio  cr
				
				<if test="areasEstudio != null">
						        WHERE cr.n_id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
				
				
			</if>
			<if test="criterioSegmentacion == 'ESCUELA'">
				mae_escuela  cr
				
				<if test="escuelas != null">
						        WHERE cr.n_id_escuela IN
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
				
				
			</if>
			<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
				(SELECT 
					DISTINCT(F_GET_TIPO_SOLICITANTE(n_id_persona)) AS v_nombre
	  			FROM mae_persona) cr
	  			
	  			<if test="solicitantes != null and solicitantes != ''">
						        WHERE cr.v_nombre IN
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
	  			
	  			
	  			
			</if>
			<if test="criterioSegmentacion == 'RECURSO'">
				mae_tipo_recurso cr
				WHERE cr.v_usable='SI'
				
				<if test="recursos != null ">
					        AND  cr.n_id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
				
			</if>
			
			
			
	</select>

	
	<select id="buscarPorEjeXSinSegementar" resultMap="objetoSinSegmentar">
			SELECT
			      lista.v_nombre												AS ejeX,
				<if test="tipoPeriodo == 'DIA'">
					
<!-- 					cantidad de prestamos -->
					(SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN #{fechaInicio} AND #{fechaFin} )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos,

<!-- 						estadia total -->
					COALESCE(SEC_TO_TIME2(
					(SELECT 
						SUM(TIME_TO_SEC(estadia))
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN #{fechaInicio} AND #{fechaFin} )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0) 							AS estadiaTotal,


<!-- 						estadia promedio -->

					IFNULL(SEC_TO_TIME2(
					
					(SELECT 
						IFNULL(AVG(TIME_TO_SEC(estadia)),0)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN #{fechaInicio} AND #{fechaFin} )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0)  						AS estadiaPromedio
									
				</if>
				<if test="tipoPeriodo == 'SEMANA'">
					
<!-- 					cantidad de prestamos -->
					(SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio}) AND F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin}) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos,

<!-- 						estadia total -->
					COALESCE(SEC_TO_TIME2(
					(SELECT 
						SUM(TIME_TO_SEC(estadia))
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio}) AND F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin}) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0) 							AS estadiaTotal,


<!-- 						estadia promedio -->

					IFNULL(SEC_TO_TIME2(
					
					(SELECT 
						IFNULL(AVG(TIME_TO_SEC(estadia)),0)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio}) AND F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin}) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0)  						AS estadiaPromedio
				    
				    
				</if>
				<if test="tipoPeriodo == 'MES'">
				   
<!-- 					cantidad de prestamos -->
					(SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null) AND F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos,

<!-- 						estadia total -->
					COALESCE(SEC_TO_TIME2(
					(SELECT 
						SUM(TIME_TO_SEC(estadia))
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null) AND F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0) 							AS estadiaTotal,


<!-- 						estadia promedio -->

					IFNULL(SEC_TO_TIME2(
					
					(SELECT 
						IFNULL(AVG(TIME_TO_SEC(estadia)),0)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null) AND F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0)  						AS estadiaPromedio
				    
				</if>
				<if test="tipoPeriodo == 'ANIO'">
				    
<!-- 					cantidad de prestamos -->
					(SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null) AND F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
								  
						)					AS numeroPrestamos,

<!-- 						estadia total -->
					COALESCE(SEC_TO_TIME2(
					(SELECT 
						SUM(TIME_TO_SEC(estadia))
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null) AND F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0) 							AS estadiaTotal,


<!-- 						estadia promedio -->

					IFNULL(SEC_TO_TIME2(
					
					(SELECT 
						IFNULL(AVG(TIME_TO_SEC(estadia)),0)
						FROM vw_reporte_prestamos
					WHERE (fecha_registro BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null) AND F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null) )
						 <if test="ejeX == 'AREA_ESTUDIO'">
							AND area_estudio=lista.v_nombre
							
						</if>
						<if test="ejeX == 'ESCUELA'">
							AND escuela=lista.v_nombre
							
						</if>
						
						  <if test="recursos != null ">
					        AND  id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>)
					
					),0)  						AS estadiaPromedio
				    
				    
				</if>

			FROM 
			<if test="ejeX == 'AREA_ESTUDIO'">
				(SELECT v_nombre, n_id_area_estudio
	  			FROM mae_area_estudio) lista
	  			
	  			<if test="areasEstudio != null">
						        WHERE lista.n_id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    						   
			</if>
			<if test="ejeX == 'ESCUELA'">
				(SELECT v_nombre, n_id_escuela
	  			FROM mae_escuela) lista
	  			
						    <if test="escuelas != null">
						        WHERE lista.n_id_escuela IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
	  			
			</if>
			GROUP BY 
				lista.v_nombre		
	</select>
		
	
	<select id="buscarPorEjeXSegmentado" resultMap="objetoSegmentado">
			SELECT
			      lista.v_nombre												AS ejeX,
			      cr.v_nombre 												AS criterioSegmentacion,
				<if test="tipoPeriodo == 'DIA'">
					(SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos rep
						<if test="criterioSegmentacion == 'RECURSO'">
							LEFT JOIN mae_recurso rec ON (rep.recurso=rec.v_descripcion)
                        	LEFT JOIN mae_tipo_recurso trec ON (rec.n_id_tipo_recurso=trec.n_id_tipo_recurso)
						</if>
						WHERE fecha_registro BETWEEN #{fechaInicio} AND  #{fechaFin}
					         <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'RECURSO'">
								AND trec.v_nombre=cr.v_nombre
							 </if>
							 
							  <if test="recursos != null ">
					        AND  rep.id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND rep.id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND rep.id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND rep.nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
							 
							 
                              )						AS numeroPrestamos
				</if>
				<if test="tipoPeriodo == 'SEMANA'">
					(SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos rep
						<if test="criterioSegmentacion == 'RECURSO'">
							LEFT JOIN mae_recurso rec ON (rep.recurso=rec.v_descripcion)
                        	LEFT JOIN mae_tipo_recurso trec ON (rec.n_id_tipo_recurso=trec.n_id_tipo_recurso)
						</if>
						WHERE fecha_registro BETWEEN  F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio})
                              AND  F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin})
                              <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'RECURSO'">
								AND trec.v_nombre=cr.v_nombre
							 </if>
							 
							  <if test="recursos != null ">
					        AND  rep.id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND rep.id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND rep.id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND rep.nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
							 
					          
                              )						AS numeroPrestamos
				</if>
				<if test="tipoPeriodo == 'MES'">
				   (SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos rep
						<if test="criterioSegmentacion == 'RECURSO'">
							LEFT JOIN mae_recurso rec ON (rep.recurso=rec.v_descripcion)
                        	LEFT JOIN mae_tipo_recurso trec ON (rec.n_id_tipo_recurso=trec.n_id_tipo_recurso)
						</if>
						WHERE fecha_registro BETWEEN  F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null)
                              AND  F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null)
                              <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'RECURSO'">
								AND trec.v_nombre=cr.v_nombre
							 </if>
					          
					           <if test="recursos != null ">
					        AND  rep.id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND rep.id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND rep.id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND rep.nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					          
                              )						AS numeroPrestamos
				</if>
				<if test="tipoPeriodo == 'ANIO'">
				   (SELECT 
						COUNT(fecha_registro)
						FROM vw_reporte_prestamos rep
						<if test="criterioSegmentacion == 'RECURSO'">
							LEFT JOIN mae_recurso rec ON (rep.recurso=rec.v_descripcion)
                        	LEFT JOIN mae_tipo_recurso trec ON (rec.n_id_tipo_recurso=trec.n_id_tipo_recurso)
						</if>
						WHERE fecha_registro BETWEEN  F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null)
                              AND  F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null)
                              <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'RECURSO'">
								AND trec.v_nombre=cr.v_nombre
							 </if>
					          
					           <if test="recursos != null ">
					        AND  rep.id_tipo_recurso IN
					        <foreach item="item" index="index" collection="recursos"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
							  
					    </if>
					
						<if test="areasEstudio != null">
					        AND rep.id_area_estudio IN
					        <foreach item="item" index="index" collection="areasEstudio"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    
					    <if test="escuelas != null">
					        AND rep.id_escuela IN 
					        <foreach item="item" index="index" collection="escuelas"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					    			    
					    <if test="solicitantes != null and solicitantes != '' ">
					        AND rep.nombre_tipo IN 
					        <foreach item="item" index="index" collection="solicitantes"
							      open="(" separator="," close=")">
							        #{item}
							  </foreach>
					    </if>
					          
                              )						AS numeroPrestamos
				</if>

			FROM 
			<if test="ejeX == 'AREA_ESTUDIO'">
				(SELECT v_nombre, n_id_area_estudio
	  			FROM mae_area_estudio) lista,
	  				  			
				<if test="criterioSegmentacion == 'ESCUELA'">
					mae_escuela  cr
				</if>
				<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
					(SELECT 
						DISTINCT(F_GET_TIPO_SOLICITANTE(n_id_persona)) AS v_nombre
		  			FROM mae_persona) cr
				</if>
				<if test="criterioSegmentacion == 'RECURSO'">
					(SELECT v_nombre
					 FROM mae_tipo_recurso 
					 WHERE v_usable='SI') cr
				</if>
				
				<if test="areasEstudio != null">
						        WHERE lista.n_id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
	  			
			</if>
			<if test="ejeX == 'ESCUELA'">
				(SELECT v_nombre, n_id_escuela
	  			FROM mae_escuela) lista,
	  			
	  			<if test="criterioSegmentacion == 'AREA_ESTUDIO'">
					mae_area_estudio  cr
				</if>
				<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
					(SELECT 
						DISTINCT(F_GET_TIPO_SOLICITANTE(n_id_persona)) AS v_nombre
		  			FROM mae_persona) cr
				</if>
				<if test="criterioSegmentacion == 'RECURSO'">
					(SELECT v_nombre
					 FROM mae_tipo_recurso 
					 WHERE v_usable='SI') cr
				</if>
	  			<if test="escuelas != null">
						        WHERE lista.n_id_escuela IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			</if>
			
	
	</select>

	<resultMap type="ReportePrestamosPorEjeXSegmentado" id="objetoSegmentado">
			<id property="ejeX" column="ejeX"></id>
			<collection property="detalle" javaType="List" ofType="ReportePrestamosPorEjeXSegmentadoDetalle">
					<result property="ejeX" column="ejeX"></result>
					<result property="segmento" column="criterioSegmentacion"></result>
					<result property="numeroPrestamos" column="numeroPrestamos"></result>
			</collection>
	</resultMap>
	
	<resultMap type="ReporteEstadisticaPrestamosPorEjeX" id="objetoSinSegmentar">
		<id property="numeroPrestamos" column="numeroPrestamos"></id>
		<id property="ejeX" column="ejeX"></id>
		<id property="estadiaTotal" column="estadiaTotal"></id>
		<id property="estadiaPromedio" column="estadiaPromedio"></id>
	</resultMap>
	
	
	<resultMap type="ConsultaRankingAlumno" id="consultaRank">
		<id property="nombres" column="nombres"></id>
		<id property="codigo" column="codigo"></id>
		<id property="cantidad" column="cantidad"></id>
		<id property="escuela" column="escuela"></id>
		<id property="idArea" column="idArea"></id>
		<id property="idEscuela" column="idEscuela"></id>
		<id property="idFacultad" column="idFacultad"></id>
		
		
	</resultMap>

	<resultMap type="ConsultaFacEsc" id="consultaRankEsc">
		<id property="escuela" column="escuela"></id>
		
		<id property="cantidad" column="cantidad"></id>
		
	</resultMap>
	
	<resultMap type="ConsultaFacEsc" id="consultaRankFac">
		
		<id property="facultad" column="facultad"></id>
		<id property="cantidad" column="cantidad"></id>
		
	</resultMap>

	

</mapper>