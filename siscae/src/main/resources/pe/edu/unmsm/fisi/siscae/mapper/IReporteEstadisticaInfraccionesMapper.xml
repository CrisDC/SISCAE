<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pe.edu.unmsm.fisi.siscae.mapper.IReporteEstadisticaInfraccionesMapper">

	<resultMap type="ReporteEstadisticaInfraccionesPorPeriodo" id="objetoResultadoSinSegmentar">
		<id property="numeroInfracciones" column="numeroInfracciones"></id>
		<id property="periodoInfraccion" column="periodoInfraccion"></id>
		<id property="numeroInfraccionesPromedioPorAlumno" column="numeroInfraccionesPromedioPorAlumno"></id>
		<id property="numeroSancionados" column="numeroSancionados"></id>
	</resultMap>
	
	<!--    ¡¡ OBSERVACION !!              '&lt;'   significa   '<' -->
	
	<select id="buscarPorPeriodoSinSegementar" resultMap="objetoResultadoSinSegmentar">
			WITH RECURSIVE ListaPeriodo  AS
			(		
				<if test="tipoPeriodo == 'DIA'">
					SELECT #{fechaInicio}  						AS fecha					
					UNION ALL
					SELECT DATE_ADD(fecha,INTERVAL 1 DAY) 		AS fecha	
					FROM ListaPeriodo
					WHERE fecha &lt; #{fechaFin}
				</if>
				
				<if test="tipoPeriodo == 'SEMANA'">
					SELECT 	#{semanaInicio}                    	AS semana,
							#{anioInicio}						AS anio
					UNION ALL
					SELECT IF(semana &lt;= 51,semana + 1,1) 		AS semana,
						   IF(semana = 52,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND semana &lt; #{semanaFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'MES'">
					SELECT #{mesInicio} 						AS mes,
						   #{anioInicio}						AS anio
					UNION ALL
					SELECT IF(mes &lt;= 11,mes + 1,1) 			AS mes,
						   IF(mes = 12,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND mes &lt; #{mesFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'ANIO'">
					SELECT #{anioInicio} 						AS anio
					UNION ALL
					SELECT (anio+1) 							AS anio
					FROM ListaPeriodo
					WHERE anio &lt; #{anioFin}
				</if>
					
			)
			SELECT
				COUNT(reporte.nombre)										AS numeroInfracciones,
				 SUM(CASE WHEN reporte.estado_solicitante='SANCIONADO'
			         THEN 1 ELSE 0 END) 									AS numeroSancionados,
			<if test="tipoPeriodo == 'DIA'">
			    lista.fecha 												AS periodoInfraccion,
				(SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
						DISTINCT(reporte.numero_documento),
						F_CANTIDAD_INFRACCIONES(reporte.numero_documento, lista.fecha , lista.fecha ) AS nInfracciones
						FROM vw_reporte_infracciones reporte
						WHERE reporte.fecha_infraccion BETWEEN lista.fecha  AND lista.fecha 
					  ) as consulta
			    )															AS numeroInfraccionesPromedioPorAlumno
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
			    CONCAT(lista.anio,'-',lista.semana)							AS periodoInfraccion,
			    (SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
						DISTINCT(reporte.numero_documento),
						F_CANTIDAD_INFRACCIONES(reporte.numero_documento, F_GENERADOR_FECHAS('INI', 'SEMANA',lista.anio,null, null, lista.semana) , F_GENERADOR_FECHAS('FIN', 'SEMANA',lista.anio,null, null, lista.semana)  ) AS nInfracciones
						FROM vw_reporte_infracciones reporte
						WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',lista.anio,null, null, lista.semana)   AND F_GENERADOR_FECHAS('FIN', 'SEMANA',lista.anio,null, null, lista.semana) 
					  ) as consulta
			    )															AS numeroInfraccionesPromedioPorAlumno
			</if>
			<if test="tipoPeriodo == 'MES'">
			    CONCAT(lista.anio,'-',lista.mes)							AS periodoInfraccion,
			    (SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
						DISTINCT(reporte.numero_documento),
						F_CANTIDAD_INFRACCIONES(reporte.numero_documento, F_GENERADOR_FECHAS('INI', 'MES',lista.anio,lista.mes, null,null) , F_GENERADOR_FECHAS('FIN', 'SEMANA',lista.anio,lista.mes, null,null)  ) AS nInfracciones
						FROM vw_reporte_infracciones reporte
						WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',lista.anio,lista.mes, null,null)   AND F_GENERADOR_FECHAS('FIN', 'SEMANA',lista.anio,lista.mes, null,null) 
					  ) as consulta
			    )												AS numeroInfraccionesPromedioPorAlumno
			</if>
			<if test="tipoPeriodo == 'ANIO'">
			    lista.anio													AS periodoInfraccion,
			    (SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
						DISTINCT(reporte.numero_documento),
						F_CANTIDAD_INFRACCIONES(reporte.numero_documento, F_GENERADOR_FECHAS('INI', 'ANIO',lista.anio,null, null,null) , F_GENERADOR_FECHAS('FIN', 'ANIO',lista.anio,null, null,null)  ) AS nInfracciones
						FROM vw_reporte_infracciones reporte
						WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',lista.anio,null, null,null)   AND F_GENERADOR_FECHAS('FIN','ANIO',lista.anio,null, null,null) 
					  ) as consulta
			    )												AS numeroInfraccionesPromedioPorAlumno
			</if>
			
			FROM ListaPeriodo lista
			<if test="tipoPeriodo == 'DIA'">
			LEFT JOIN vw_reporte_infracciones reporte ON (reporte.fecha_infraccion = lista.fecha)
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
			LEFT JOIN vw_reporte_infracciones reporte ON (CONCAT(lista.anio,'-',lista.semana) = CONCAT(YEAR(reporte.fecha_infraccion),'-',WEEK(reporte.fecha_infraccion)))
			</if>
			<if test="tipoPeriodo == 'MES'">
			LEFT JOIN vw_reporte_infracciones reporte ON (CONCAT(lista.anio,'-',lista.mes) = CONCAT(YEAR(reporte.fecha_infraccion),'-',MONTH(reporte.fecha_infraccion)))
			</if>
			 <if test="tipoPeriodo == 'ANIO'">
			LEFT JOIN vw_reporte_infracciones reporte ON (lista.anio = YEAR(reporte.fecha_infraccion))
			</if>
			
			GROUP BY
			<if test="tipoPeriodo == 'DIA'">
			    lista.fecha
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
			    lista.anio,
    			lista.semana
			 </if>
			 <if test="tipoPeriodo == 'MES'">
				lista.anio,
				lista.mes
			 </if>
			 <if test="tipoPeriodo == 'ANIO'">
			    lista.anio
			 </if>
	</select>


</mapper>