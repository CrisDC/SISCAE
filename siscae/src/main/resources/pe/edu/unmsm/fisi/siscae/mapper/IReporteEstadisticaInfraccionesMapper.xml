<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pe.edu.unmsm.fisi.siscae.mapper.IReporteEstadisticaInfraccionesMapper">

	
	
	
	<!--    ¡¡ OBSERVACION !!              '&lt;'   significa   '<' -->
	
	
	<select id="buscarPorNumeroDocumento" resultMap="consultaInf">
			
		select numero_documento as numeroDocumento,
				tipo_documento as tipoDocumento,
		        app_paterno as appPaterno,
		        app_materno as appMaterno,
		        descripcion as descripcion,
		        fecha_infraccion as fechaInfraccion,
		        estado_infraccion as estadoInfraccion,
		        estado_solicitante as estadoSolicitante,
		        nombre as nombre
		        
		        from vw_reporte_infracciones where numero_documento=#{numeroDocumento};
			
			
			
	</select>
	
	
	
	<select id="buscarPorPeriodoSinSegementar" resultMap="objetoSinSegmentar">
			WITH RECURSIVE ListaPeriodo  AS
			(		
				<if test="tipoPeriodo == 'DIA'">
					SELECT #{fechaInicio}  						AS fecha					
					UNION ALL
					SELECT DATE_ADD(fecha,INTERVAL 1 DAY) 		AS fecha	
					FROM ListaPeriodo
					WHERE fecha &lt; #{fechaFin}
				</if>
				
				<if test="tipoPeriodo == 'SEMANA'">
					SELECT 	#{semanaInicio}                    	AS semana,
							#{anioInicio}						AS anio
					UNION ALL
					SELECT IF(semana &lt;= 51,semana + 1,1) 		AS semana,
						   IF(semana = 52,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND semana &lt; #{semanaFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'MES'">
					SELECT #{mesInicio} 						AS mes,
						   #{anioInicio}						AS anio
					UNION ALL
					SELECT IF(mes &lt;= 11,mes + 1,1) 			AS mes,
						   IF(mes = 12,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND mes &lt; #{mesFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'ANIO'">
					SELECT #{anioInicio} 						AS anio
					UNION ALL
					SELECT (anio+1) 							AS anio
					FROM ListaPeriodo
					WHERE anio &lt; #{anioFin}
				</if>
					
			)
			SELECT
			<if test="tipoPeriodo == 'DIA'">
				lista.fecha 												AS ejeX,
			(SELECT 
							COUNT(fecha_infraccion)
							FROM vw_reporte_infracciones rep
						WHERE rep.fecha_infraccion BETWEEN lista.fecha  AND lista.fecha
						<if test="areasEstudio != null">
						        AND rep.id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND rep.id_escuela_programa IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND rep.nombre_tipo IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND rep.id_tipo_infraccion IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND rep.id_estado_infraccion IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						
						 )	AS numeroInfracciones,
                
				(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE (reporte.fecha_infraccion BETWEEN #{fechaInicio}  AND #{fechaFin})
							) consulta
							
							WHERE consulta.est_inf='PENALIZADA' AND (consulta.fec_inf BETWEEN lista.fecha  AND lista.fecha)
							<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			     		)						AS numeroSancionados,
			     		
						(SELECT COALESCE(AVG(F_CANTIDAD_INFRACCIONES(consulta.docu, lista.fecha , lista.fecha )),0)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as docu,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE (reporte.fecha_infraccion BETWEEN #{fechaInicio}  AND #{fechaFin})
													
					  ) consulta
					  WHERE (consulta.fec_inf BETWEEN lista.fecha  AND lista.fecha)
					  
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCIONs'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					
			    )															AS numeroInfraccionesPromedioPorAlumno
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
				CONCAT(lista.anio,'-',lista.semana)							AS ejeX,
<!-- 				F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS',null,  -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,lista.semana ), -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,lista.semana),  -->
<!--                 'CANTIDAD_INFRACCIONES')	AS numeroInfracciones, -->
                
<!-- 				F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS', null, -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,lista.semana ),  -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,lista.semana ),  -->
<!--                 'CANTIDAD_SANCIONADOS')	AS numeroSancionados, -->
				 
<!-- 			    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS', null, -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio,null,null,lista.semana),  -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,lista.semana ),  -->
<!--                 'CANTIDAD_INFRACCIONES_PROMEDIO')	AS numeroInfraccionesPromedioPorAlumno -->
                
                
                
                (SELECT 
							COUNT(fecha_infraccion)
							FROM vw_reporte_infracciones rep
						WHERE rep.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,lista.semana )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,lista.semana)
						<if test="areasEstudio != null">
						        AND rep.id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND rep.id_escuela_programa IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND rep.nombre_tipo IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND rep.id_tipo_infraccion IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND rep.id_estado_infraccion IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						
						 )	AS numeroInfracciones,
                
				(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE (reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, #{anioInicio}, null,null,#{semanaInicio} )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, #{anioFin}, null,null,#{semanaFin}))
							) consulta
							
							WHERE consulta.est_inf='PENALIZADA' AND (consulta.fec_inf BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,lista.semana )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,lista.semana))
							<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			     		)						AS numeroSancionados,
			     		
						(SELECT COALESCE(AVG(F_CANTIDAD_INFRACCIONES(consulta.docu,F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,lista.semana ) ,F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,lista.semana) )),0)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as docu,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE (reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, #{anioInicio}, null,null,#{semanaInicio} )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, #{anioFin}, null,null,#{semanaFin}))
													
					  ) consulta
					  WHERE (consulta.fec_inf BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,lista.semana )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,lista.semana))
					  
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCIONs'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					
			    )															AS numeroInfraccionesPromedioPorAlumno
                
                
                
			</if>
			<if test="tipoPeriodo == 'MES'">
				CONCAT(lista.anio,'-',lista.mes)							AS ejeX,
<!-- 				F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS',null,  -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio,lista.mes,null,null ), -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,lista.mes,null,null),  -->
<!--                 'CANTIDAD_INFRACCIONES')	AS numeroInfracciones, -->
                
<!-- 				F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS', null, -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio,lista.mes,null,null ),  -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,lista.mes,null,null ),  -->
<!--                 'CANTIDAD_SANCIONADOS')	AS numeroSancionados, -->
				 
<!-- 			    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS', null, -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio,lista.mes,null,null),  -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,lista.mes,null,null),  -->
<!--                 'CANTIDAD_INFRACCIONES_PROMEDIO')	AS numeroInfraccionesPromedioPorAlumno -->
				
				
				(SELECT 
							COUNT(fecha_infraccion)
							FROM vw_reporte_infracciones rep
						WHERE rep.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, lista.mes,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo},lista.anio, lista.mes,null,null)
						<if test="areasEstudio != null">
						        AND rep.id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND rep.id_escuela_programa IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND rep.nombre_tipo IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND rep.id_tipo_infraccion IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND rep.id_estado_infraccion IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						
						 )	AS numeroInfracciones,
                
				(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE (reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, #{anioInicio}, #{mesInicio},null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, #{anioFin}, #{mesFin},null,null))
							) consulta
							
							WHERE consulta.est_inf='PENALIZADA' AND (consulta.fec_inf BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, lista.mes,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,lista.mes,null,null))
							<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			     		)						AS numeroSancionados,
			     		
						(SELECT COALESCE(AVG(F_CANTIDAD_INFRACCIONES(consulta.docu,F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, lista.mes,null,null ) ,F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,lista.mes,null,null) )),0)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as docu,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE (reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, #{anioInicio}, #{mesInicio},null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, #{anioFin}, #{mesFin},null,null))
													
					  ) consulta
					  WHERE (consulta.fec_inf BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, lista.mes,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,lista.mes,null,null))
					  
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCIONs'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					
			    )															AS numeroInfraccionesPromedioPorAlumno
                
				
			</if>
			<if test="tipoPeriodo == 'ANIO'">
				lista.anio													AS ejeX,
<!-- 				F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS',null,  -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio,null,null,null ), -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,null),  -->
<!--                 'CANTIDAD_INFRACCIONES')	AS numeroInfracciones, -->
                
<!-- 				F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS', null, -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio,null,null,null),  -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,null),  -->
<!--                 'CANTIDAD_SANCIONADOS')	AS numeroSancionados, -->
				 
<!-- 			    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN('TODOS', null, -->
<!--                 F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio,null,null,null),  -->
<!--                 F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,null),  -->
<!--                 'CANTIDAD_INFRACCIONES_PROMEDIO')	AS numeroInfraccionesPromedioPorAlumno -->
                
                
				(SELECT 
							COUNT(fecha_infraccion)
							FROM vw_reporte_infracciones rep
						WHERE rep.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo},lista.anio, null,null,null)
						<if test="areasEstudio != null">
						        AND rep.id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND rep.id_escuela_programa IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND rep.nombre_tipo IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND rep.id_tipo_infraccion IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND rep.id_estado_infraccion IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						
						 )	AS numeroInfracciones,
                
				(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE (reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, #{anioInicio}, null,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, #{anioFin}, null,null,null))
							) consulta
							
							WHERE consulta.est_inf='PENALIZADA' AND (consulta.fec_inf BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,null))
							<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			     		)						AS numeroSancionados,
			     		
						(SELECT COALESCE(AVG(F_CANTIDAD_INFRACCIONES(consulta.docu,F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,null ) ,F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,null) )),0)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as docu,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE (reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, #{anioInicio},null,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, #{anioFin}, null,null,null))
													
					  ) consulta
					  WHERE (consulta.fec_inf BETWEEN F_GENERADOR_FECHAS('INI', #{tipoPeriodo}, lista.anio, null,null,null )  AND F_GENERADOR_FECHAS('FIN', #{tipoPeriodo}, lista.anio,null,null,null))
					  
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCIONs'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					
			    )															AS numeroInfraccionesPromedioPorAlumno
                
                
                
			</if>
			
				
			FROM ListaPeriodo lista
			GROUP BY
			<if test="tipoPeriodo == 'DIA'">
			    lista.fecha
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
			    lista.anio,
    			lista.semana
			 </if>
			 <if test="tipoPeriodo == 'MES'">
				lista.anio,
				lista.mes
			 </if>
			 <if test="tipoPeriodo == 'ANIO'">
			    lista.anio
			 </if>
	</select>
	
	<select id="buscarPorCriterio" resultMap="objetoSinSegmentar">
		SELECT 
			COUNT(fecha_infraccion) as numeroInfracciones,
			<if test="serie == 'ESCUELA'">
				r.escuela_programa			as segmento,
			</if>
			<if test="serie == 'AREA_ESTUDIO'">
				r.area_estudio		as segmento,
			</if>
			<if test="serie == 'SOLICITANTE'">
				r.nombre_tipo		as segmento,
			</if>
			<if test="serie == 'TIPO_INFRACCION'">
				r.tipo_infraccion		as segmento,
			</if>
			
			<if test="tipoPeriodo == 'DIA'">
				(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) 	as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE (reporte.fecha_infraccion BETWEEN #{fechaInicio}  AND #{fechaFin})
							) consulta
							
							WHERE consulta.est_inf='PENALIZADA'
							<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			     		)						AS numeroSancionados,
			     		
						(SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento),
							F_CANTIDAD_INFRACCIONES(reporte.numero_documento, #{fechaInicio} , #{fechaFin} ) AS nInfracciones,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE (reporte.fecha_infraccion BETWEEN #{fechaInicio}  AND #{fechaFin})
													
					  ) consulta
					  <where> 
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					</where>
			    )															AS numeroInfraccionesPromedioPorAlumno
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
				(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null, #{semanaInicio})   AND F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null, #{semanaFin})
					     	 )consulta
			    			 WHERE consulta.est_inf='PENALIZADA'
			    			 <if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			    			 
			    			 )						AS numeroSancionados,
			    			 
			    (SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento),
							F_CANTIDAD_INFRACCIONES(reporte.numero_documento, F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null, #{semanaInicio}) , F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null, #{semanaFin})  ) AS nInfracciones,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null, #{semanaInicio})   AND F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null, #{semanaFin}) 
					  	) consulta
					  	<where> 
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					</where>
			    )															AS numeroInfraccionesPromedioPorAlumno
			</if>
			<if test="tipoPeriodo == 'MES'">
				(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null)   AND F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null) 
					     	)consulta
			     			WHERE consulta.est_inf='PENALIZADA'
			    			 <if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    )						AS numeroSancionados,
			    (SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento),
							F_CANTIDAD_INFRACCIONES(reporte.numero_documento, F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null) , F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null)  ) AS nInfracciones,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null)   AND F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null) 
					 	) consulta
					 	<where> 
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					</where>
			    )												AS numeroInfraccionesPromedioPorAlumno
			</if>
			<if test="tipoPeriodo == 'ANIO'">
			(SELECT COUNT(consulta.est_inf)
					FROM (SELECT 
							DISTINCT(reporte.numero_documento) as num_doc,
			                reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
							FROM vw_reporte_infracciones reporte
							WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null)   AND F_GENERADOR_FECHAS('FIN','ANIO',#{anioFin},null, null,null) 
					     	)consulta
			    			 WHERE consulta.est_inf='PENALIZADA'
			    			 <if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						        
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>)						AS numeroSancionados,
			    (SELECT AVG(consulta.nInfracciones)
			     FROM (SELECT 
							DISTINCT(reporte.numero_documento),
							F_CANTIDAD_INFRACCIONES(reporte.numero_documento, F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null) , F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null)  ) AS nInfracciones,
							reporte.estado_infraccion		   	as est_inf,
                            reporte.id_estado_infraccion		as id_est_inf,
			                reporte.fecha_infraccion		  	as fec_inf,
                            reporte.escuela_programa			as esc,
                            reporte.id_escuela_programa			as id_esc,
                            reporte.area_estudio				as area,
                            reporte.id_area_estudio				as id_area,
                            reporte.nombre_tipo					as nomb,
                            reporte.tipo_infraccion				as tipo_inf,
                            reporte.id_tipo_infraccion			as id_tipo_inf
						FROM vw_reporte_infracciones reporte
						WHERE reporte.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null)   AND F_GENERADOR_FECHAS('FIN','ANIO',#{anioFin},null, null,null) 
					  	) consulta
					  	<where> 
					  		<if test="serie == 'ESCUELA'">
									AND consulta.esc=r.escuela_programa
							</if>
							<if test="serie == 'AREA_ESTUDIO'">
								    AND consulta.area=r.area_estudio
							</if>
							<if test="serie == 'SOLICITANTE'">
									AND consulta.nomb=r.nombre_tipo
							</if>
							<if test="serie == 'TIPO_INFRACCION'">
									AND consulta.tipo_inf=r.tipo_infraccion
							</if>
							
							<if test="areasEstudio != null">
						        AND consulta.id_area IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND consulta.id_esc IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND consulta.nomb IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND consulta.id_tipo_inf IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND consulta.id_est_inf IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if> 
					</where>
			    )												AS numeroInfraccionesPromedioPorAlumno
			</if>
		    
		FROM vw_reporte_infracciones r
		LEFT JOIN mae_persona pe ON (pe.v_num_documento=r.numero_documento)
		WHERE 
			<if test="tipoPeriodo == 'DIA'">
				    r.fecha_infraccion BETWEEN #{fechaInicio}  AND #{fechaFin}
			</if>
			<if test="tipoPeriodo == 'SEMANA'">
				   r.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio} ,null, null, #{semanaInicio} )
				   AND F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioInicio} ,null, null, #{semanaInicio} )
			</if>
			<if test="tipoPeriodo == 'MES'">
				   r.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio} ,#{mesInicio}, null, null )
				   AND F_GENERADOR_FECHAS('FIN', 'MES',#{anioInicio} ,#{mesInicio}, null, null )
			</if>
			<if test="tipoPeriodo == 'ANIO'">
				    r.fecha_infraccion BETWEEN F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio} ,null, null, null )
				   AND F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioInicio} ,null, null, null )
			</if>
			
							<if test="areasEstudio != null">
						        AND r.id_area_estudio IN
						        <foreach item="item" index="index" collection="areasEstudio"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="escuelas != null">
						        AND r.id_escuela_programa IN 
						        <foreach item="item" index="index" collection="escuelas"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    		    

						    
						    <if test="solicitantes != null and solicitantes != '' ">
						        AND r.nombre_tipo IN 
						        <foreach item="item" index="index" collection="solicitantes"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoInfracciones != null">
						        AND r.id_tipo_infraccion IN 
						        <foreach item="item" index="index" collection="tipoInfracciones"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
						    
						    <if test="tipoEstados != null">
						        AND r.id_estado_infraccion IN 
						        <foreach item="item" index="index" collection="tipoEstados"
								      open="(" separator="," close=")">
								        #{item}
								  </foreach>
						    </if>
			
		<if test="serie == 'ESCUELA'">
				GROUP BY r.escuela_programa
		</if>
		<if test="serie == 'AREA_ESTUDIO'">
				GROUP BY r.area_estudio
		</if>
		<if test="serie == 'SOLICITANTE'">
				GROUP BY r.nombre_tipo
		</if>
		<if test="serie == 'TIPO_INFRACCION'">
				GROUP BY r.tipo_infraccion
		</if>
	</select>
	
	<select id="buscarPorPeriodoSegmentado" resultMap="objetoSegmentado">
			WITH RECURSIVE ListaPeriodo  AS
			(		
				<if test="tipoPeriodo == 'DIA'">
					SELECT #{fechaInicio}  						AS fecha					
					UNION ALL
					SELECT DATE_ADD(fecha,INTERVAL 1 DAY) 		AS fecha	
					FROM ListaPeriodo
					WHERE fecha &lt; #{fechaFin}
				</if>
				
				<if test="tipoPeriodo == 'SEMANA'">
					SELECT 	#{semanaInicio}                    	AS semana,
							#{anioInicio}						AS anio
					UNION ALL
					SELECT IF(semana &lt;= 51,semana + 1,1) 		AS semana,
						   IF(semana = 52,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND semana &lt; #{semanaFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'MES'">
					SELECT #{mesInicio} 						AS mes,
						   #{anioInicio}						AS anio
					UNION ALL
					SELECT IF(mes &lt;= 11,mes + 1,1) 			AS mes,
						   IF(mes = 12,anio + 1,anio)  			AS anio
					FROM ListaPeriodo
					WHERE (anio = #{anioFin} AND mes &lt; #{mesFin}) OR (anio &lt; #{anioFin})
				</if>
				
				<if test="tipoPeriodo == 'ANIO'">
					SELECT #{anioInicio} 						AS anio
					UNION ALL
					SELECT (anio+1) 							AS anio
					FROM ListaPeriodo
					WHERE anio &lt; #{anioFin}
				</if>
					
			)
			SELECT
			      cr.v_nombre 												AS criterioSegmentacion,
				<if test="tipoPeriodo == 'DIA'">
					lista.fecha 											AS ejeX,
				    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{criterioSegmentacion}, cr.v_nombre,lista.fecha,
					adddate(lista.fecha, INTERVAL 1 DAY),
					'CANTIDAD_INFRACCIONES')  								AS numeroInfracciones
				</if>
				<if test="tipoPeriodo == 'SEMANA'">
				    CONCAT(lista.anio,'-',lista.semana)							AS ejeX,
				    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{criterioSegmentacion}, cr.v_nombre,
				    F_GENERADOR_FECHAS('INI', 'SEMANA',lista.anio,null, null,lista.semana),
				    F_GENERADOR_FECHAS('FIN', 'SEMANA',lista.anio,null, null,lista.semana),
				    'CANTIDAD_INFRACCIONES')  									AS numeroInfracciones
				</if>
				<if test="tipoPeriodo == 'MES'">
				    CONCAT(lista.anio,'-',lista.mes)							AS ejeX,
				    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{criterioSegmentacion}, cr.v_nombre,
				    F_GENERADOR_FECHAS('INI', 'MES',lista.anio,lista.mes, null,null),
				    F_GENERADOR_FECHAS('FIN', 'MES',lista.anio,lista.mes, null,null),
				    'CANTIDAD_INFRACCIONES')  									AS numeroInfracciones
				</if>
				<if test="tipoPeriodo == 'ANIO'">
				    lista.anio													AS ejeX,
				    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{criterioSegmentacion}, cr.v_nombre,
				    F_GENERADOR_FECHAS('INI', 'ANIO',lista.anio,null, null,null),
				    F_GENERADOR_FECHAS('FIN', 'ANIO',lista.anio,null, null,null),
				    'CANTIDAD_INFRACCIONES')  									AS numeroInfracciones
				</if>

			FROM 
			ListaPeriodo lista ,
			<if test="criterioSegmentacion == 'AREA_ESTUDIO'">
				mae_area_estudio  cr
			</if>
			<if test="criterioSegmentacion == 'ESCUELA'">
				mae_escuela  cr
			</if>
			<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
				(SELECT 
					DISTINCT(F_GET_TIPO_SOLICITANTE(n_id_persona)) AS v_nombre
	  			FROM mae_persona) cr
			</if>
			<if test="criterioSegmentacion == 'TIPO_INFRACCION'">
				(SELECT mtd.v_descripcion as v_nombre 
	             FROM mae_multi_tab_det mtd
	             LEFT JOIN  mae_multi_tab_cab mtc ON (mtd.n_id_tabla=mtc.n_id_tabla)
	             WHERE mtc.v_nombre='TIPO INFRACCION')  cr
			</if>
			
	</select>
	
	<select id="buscarPorEjeXSinSegmentar" resultMap="objetoSinSegmentar">
			SELECT
			      lista.v_nombre												AS ejeX,
				<if test="tipoPeriodo == 'DIA'">
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,#{fechaInicio},
					 #{fechaFin},'CANTIDAD_INFRACCIONES')							AS numeroInfracciones,
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre, #{fechaInicio},
					#{fechaFin},'CANTIDAD_SANCIONADOS')							AS numeroSancionados,
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre, #{fechaInicio},
					#{fechaFin},'CANTIDAD_INFRACCIONES_PROMEDIO') 						AS numeroInfraccionesPromedioPorAlumno
				</if>
				<if test="tipoPeriodo == 'SEMANA'">
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio}),
				    F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin}),
				    'CANTIDAD_INFRACCIONES')							AS numeroInfracciones,
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio}),
				    F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin}),
				    'CANTIDAD_SANCIONADOS') 							AS numeroSancionados,
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio}),
				    F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin}),
				    'CANTIDAD_INFRACCIONES_PROMEDIO')  						AS numeroInfraccionesPromedioPorAlumno
				</if>
				<if test="tipoPeriodo == 'MES'">
				    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null),
				    F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null),
				    'CANTIDAD_INFRACCIONES')							AS numeroInfracciones,
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null),
				    F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null),
				    'CANTIDAD_SANCIONADOS') 							AS numeroSancionados,
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null),
				    F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null),
				    'CANTIDAD_INFRACCIONES_PROMEDIO')  						AS numeroInfraccionesPromedioPorAlumno
				</if>
				<if test="tipoPeriodo == 'ANIO'">
				    F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null),
				    F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null),
				    'CANTIDAD_INFRACCIONES')							AS numeroInfracciones,				
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null),
				    F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null),
				    'CANTIDAD_SANCIONADOS') 							AS numeroSancionados,
					F_OBTENER_ESTADISTICO_INFRACCIONES_BETWEEN(#{ejeX}, lista.v_nombre,
					F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null),
				    F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null),
				    'CANTIDAD_INFRACCIONES_PROMEDIO')  						AS numeroInfraccionesPromedioPorAlumno
				</if>

			FROM 
			<if test="ejeX == 'AREA_ESTUDIO'">
				(SELECT v_nombre
	  			FROM mae_area_estudio) lista
			</if>
			<if test="ejeX == 'ESCUELA'">
				(SELECT v_nombre
	  			FROM mae_escuela) lista
			</if>
			GROUP BY 
				lista.v_nombre		
	</select>

	<select id="buscarPorEjeXSegmentado" resultMap="objetoSegmentado">
			SELECT
			      lista.v_nombre												AS ejeX,
			      cr.v_nombre 												AS criterioSegmentacion,
				<if test="tipoPeriodo == 'DIA'">
					(SELECT 
						COUNT(fecha_infraccion)
						FROM vw_reporte_infracciones rep
						WHERE fecha_infraccion BETWEEN #{fechaInicio} AND  #{fechaFin}
					         <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela_programa=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela_programa=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'TIPO_INFRACCION'">
								AND rep.tipo_infraccion=cr.v_nombre
							 </if>
                              )						AS numeroInfracciones
				</if>
				<if test="tipoPeriodo == 'SEMANA'">
					(SELECT 
						COUNT(fecha_infraccion)
						FROM vw_reporte_infracciones rep
			
						WHERE fecha_infraccion BETWEEN  F_GENERADOR_FECHAS('INI', 'SEMANA',#{anioInicio},null, null,#{semanaInicio})
                              AND  F_GENERADOR_FECHAS('FIN', 'SEMANA',#{anioFin},null, null,#{semanaFin})
                              <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela_programa=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela_programa=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'TIPO_INFRACCION'">
								AND rep.tipo_infraccion=cr.v_nombre
							 </if>
					          
                              )						AS numeroInfracciones
				</if>
				<if test="tipoPeriodo == 'MES'">
				   (SELECT 
						COUNT(fecha_infraccion)
						FROM vw_reporte_infracciones rep

						WHERE fecha_infraccion BETWEEN  F_GENERADOR_FECHAS('INI', 'MES',#{anioInicio},#{mesInicio}, null,null)
                              AND  F_GENERADOR_FECHAS('FIN', 'MES',#{anioFin},#{mesFin}, null,null)
                              <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela_programa=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela_programa=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'TIPO_INFRACCION'">
								AND rep.tipo_infraccion=cr.v_nombre
							 </if>
					          
                              )						AS numeroInfracciones
				</if>
				<if test="tipoPeriodo == 'ANIO'">
				   (SELECT 
						COUNT(fecha_infraccion)
						FROM vw_reporte_infracciones rep
						WHERE fecha_infraccion BETWEEN  F_GENERADOR_FECHAS('INI', 'ANIO',#{anioInicio},null, null,null)
                              AND  F_GENERADOR_FECHAS('FIN', 'ANIO',#{anioFin},null, null,null)
                              <if test="ejeX == 'AREA_ESTUDIO'">
								AND rep.area_estudio=lista.v_nombre
							  </if>
							  <if test="ejeX == 'ESCUELA'">
								AND rep.escuela_programa=lista.v_nombre
							  </if>
                              <if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
								AND rep.nombre_tipo=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'AREA_ESTUDIO'">
								AND rep.area_estudio=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'ESCUELA'">
								AND rep.escuela_programa=cr.v_nombre
							  </if>
							  <if test="criterioSegmentacion == 'TIPO_INFRACCION'">
								AND rep.tipo_infraccion=cr.v_nombre
							 </if>
					          
                              )						AS numeroInfracciones
				</if>

			FROM 
			<if test="ejeX == 'AREA_ESTUDIO'">
				(SELECT v_nombre
	  			FROM mae_area_estudio) lista,
			</if>
			<if test="ejeX == 'ESCUELA'">
				(SELECT v_nombre
	  			FROM mae_escuela) lista,
			</if>
			<if test="criterioSegmentacion == 'AREA_ESTUDIO'">
				mae_area_estudio  cr
			</if>
			<if test="criterioSegmentacion == 'ESCUELA'">
				mae_escuela  cr
			</if>
			<if test="criterioSegmentacion == 'TIPO_SOLICITANTE'">
				(SELECT 
					DISTINCT(F_GET_TIPO_SOLICITANTE(n_id_persona)) AS v_nombre
	  			FROM mae_persona) cr
			</if>
			<if test="criterioSegmentacion == 'TIPO_INFRACCION'">
			   (SELECT v_descripcion AS  v_nombre
				FROM mae_multi_tab_det 
				WHERE n_id_tabla=(SELECT n_id_tabla 
								  FROM mae_multi_tab_cab 
								  WHERE v_nombre='TIPO INFRACCION') ) cr
			</if>
	
	</select>

	<resultMap type="ReporteEstadisticaInfraccionesPorEjeX" id="objetoSinSegmentar">
		<id property="numeroInfracciones" column="numeroInfracciones"></id>
		<id property="ejeX" column="ejeX"></id>
		<id property="numeroInfraccionesPromedioPorAlumno" column="numeroInfraccionesPromedioPorAlumno"></id>
		<id property="numeroSancionados" column="numeroSancionados"></id>
	</resultMap>
	
	<resultMap type="ReporteInfraccionesPorEjeXSegmentado" id="objetoSegmentado">
			<id property="ejeX" column="ejeX"></id>
			<collection property="detalle" javaType="List" ofType="ReporteInfraccionesPorEjeXSegmentadoDetalle">
					<result property="ejeX" column="ejeX"></result>
					<result property="segmento" column="criterioSegmentacion"></result>
					<result property="numeroInfracciones" column="numeroInfracciones"></result>
			</collection>
	</resultMap>
	
	<resultMap type="ConsultaInfracciones" id="consultaInf">
		<id property="nombre" column="nombre"></id>
		<id property="numeroDocumento" column="numeroDocumento"></id>
		<id property="appPaterno" column="appPaterno"></id>
		<id property="appMaterno" column="appMaterno"></id>
		<id property="descripcion" column="descripcion"></id>
		<id property="fechaInfraccion" column="fechaInfraccion"></id>
		<id property="estadoInfraccion" column="estadoInfraccion"></id>
		<id property="estadoSolicitante" column="estadoSolicitante"></id>
		
	</resultMap>
	
	
</mapper>